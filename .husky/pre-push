# #!/bin/sh
# . "$(dirname "$0")/_/husky.sh"

# echo "üß™ Running Unit Tests before pushing..."
# flutter test

#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

echo "üîç Running SonarQube Analysis..."

# 1. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ Docker ‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏´‡∏° (‡∏Å‡∏±‡∏ô‡πÄ‡∏´‡∏ô‡∏µ‡∏¢‡∏ß)
if ! docker info > /dev/null 2>&1; then
  echo "‚ùå Error: Docker is not running. Please start Docker first."
  exit 1
fi

# 2. ‡∏£‡∏±‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á Scanner
# -Dsonar.qualitygate.wait=true ‡∏Ñ‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç! ‡∏°‡∏±‡∏ô‡∏à‡∏∞‡∏£‡∏≠‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤ Server ‡∏à‡∏∞‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤ ‡∏ú‡πà‡∏≤‡∏ô/‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô
# ‡∏ñ‡πâ‡∏≤ Server ‡∏ï‡∏≠‡∏ö‡∏ß‡πà‡∏≤ "Failed" ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤ Exit Code ‡πÄ‡∏õ‡πá‡∏ô Error ‡∏≠‡∏≠‡∏Å‡∏°‡∏≤
sonar-scanner \
  -Dsonar.login="squ_620c44ca05e06d216f2b10a0e92313294e5d48d8" \
  -Dsonar.qualitygate.wait=true

# 3. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå ($? ‡∏Ñ‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)
if [ $? -ne 0 ]; then
    echo " "
    echo "‚ùå SonarQube Quality Gate FAILED!"
    echo "üö´ Push has been blocked. Please fix the issues above."
    exit 1  # ‡∏≠‡∏≠‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏•‡∏Ç 1 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏≠‡∏Å Git ‡∏ß‡πà‡∏≤ "‡∏´‡πâ‡∏≤‡∏° Push"
fi

echo " "
echo "‚úÖ SonarQube Passed! Pushing code..."
exit 0