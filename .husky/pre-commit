#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

echo "ğŸ¶ Husky: Manual checking on STAGED files..."

# 1. à¸«à¸²à¹„à¸Ÿà¸¥à¹Œ .dart à¸—à¸µà¹ˆà¸–à¸¹à¸ Staged (à¹€à¸‰à¸à¸²à¸°à¸—à¸µà¹ˆ Add à¸¡à¸²)
# - diff --cached --name-only : à¸”à¸¹à¸Šà¸·à¹ˆà¸­à¹„à¸Ÿà¸¥à¹Œà¹ƒà¸™ staging area
# - diff --diff-filter=ACMR : à¹€à¸­à¸²à¹€à¸‰à¸à¸²à¸°à¹„à¸Ÿà¸¥à¹Œà¸—à¸µà¹ˆ Add, Copy, Modify, Rename (à¹„à¸¡à¹ˆà¹€à¸­à¸² Deleted)
# - grep .dart$ : à¹€à¸­à¸²à¹€à¸‰à¸à¸²à¸°à¹„à¸Ÿà¸¥à¹Œà¸¥à¸‡à¸—à¹‰à¸²à¸¢à¸”à¹‰à¸§à¸¢ .dart
staged_dart_files=$(git diff --cached --name-only --diff-filter=ACMR | grep ".dart$" || true)

# 2. à¹€à¸Šà¹‡à¸„à¸§à¹ˆà¸²à¸¡à¸µà¹„à¸Ÿà¸¥à¹Œ Dart à¹„à¸«à¸¡? (à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¸¡à¸µà¸à¹‡à¸‚à¹‰à¸²à¸¡à¸à¸²à¸£ format/analyze)
if [ -z "$staged_dart_files" ]; then
  echo "âœ¨ No Dart files changed. Skipping format and analyze."
  echo "   But will still run tests and SonarQube..."
  
  # à¸‚à¹‰à¸²à¸¡à¹„à¸›à¸£à¸±à¸™ tests à¹à¸¥à¸° SonarQube
  skip_dart_checks=true
else
  skip_dart_checks=false
  # à¹à¸ªà¸”à¸‡à¸£à¸²à¸¢à¸Šà¸·à¹ˆà¸­à¹„à¸Ÿà¸¥à¹Œà¸—à¸µà¹ˆà¸ˆà¸°à¹€à¸Šà¹‡à¸„
  echo "ğŸ“ Checking these files:"
  echo "$staged_dart_files"
fi

# ---------------------------------------------------------
# 3. à¸£à¸±à¸™ Dart Format (à¹€à¸‰à¸à¸²à¸°à¹„à¸Ÿà¸¥à¹Œà¸—à¸µà¹ˆà¹€à¸¥à¸·à¸­à¸)
# ---------------------------------------------------------
if [ "$skip_dart_checks" = false ]; then
  echo ""
  echo "âœ¨ Running Dart Format..."
  dart format $staged_dart_files
fi

# ---------------------------------------------------------
# 4. à¸£à¸±à¸™ Flutter Analyze (à¹€à¸‰à¸à¸²à¸°à¹„à¸Ÿà¸¥à¹Œà¸—à¸µà¹ˆà¹€à¸¥à¸·à¸­à¸)
# ---------------------------------------------------------
echo ""
echo "ğŸ” Running Flutter Analyze..."
echo "â­ï¸  Skipping Flutter Analyze (testing SonarQube)"

# ---------------------------------------------------------
# 5. à¸£à¸±à¸™ Tests à¸à¸£à¹‰à¸­à¸¡ Generate Coverage
# ---------------------------------------------------------
echo ""
echo "ğŸ§ª Running Flutter Tests with Coverage..."
flutter test --coverage

if [ $? -ne 0 ]; then
  echo ""
  echo "âŒ Tests Failed! Please fix test errors."
  exit 1
fi

echo "âœ… Tests passed! Coverage generated at coverage/lcov.info"

# ---------------------------------------------------------
# 6. à¸£à¸±à¸™ SonarQube Analysis à¹à¸¥à¸°à¹€à¸Šà¹‡à¸„ Quality Gate
# ---------------------------------------------------------
echo ""
echo "ğŸ” Running SonarQube Analysis..."

# à¹€à¸£à¸µà¸¢à¸à¹ƒà¸Šà¹‰ script à¸—à¸µà¹ˆà¹€à¸•à¸£à¸µà¸¢à¸¡à¹„à¸§à¹‰à¹à¸¥à¹‰à¸§
bash scripts/sonar_gate.sh

# à¹€à¸à¹‡à¸š exit code
SONAR_EXIT_CODE=$?

# à¹à¸ªà¸”à¸‡ Coverage Report (à¹€à¸ªà¸¡à¸­!)
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ“Š Coverage Summary:"
if [ -f "coverage/lcov.info" ]; then
  total_lines=$(grep -c "^DA:" coverage/lcov.info || echo "0")
  
  if [ "$total_lines" -gt 0 ]; then
    coverage=$(awk "BEGIN {printf \"%.1f\", ($covered_lines/$total_lines)*100}")
    echo "   Coverage: ${coverage}%"
    echo "   Lines: ${covered_lines}/${total_lines}"
  else
    echo "   No coverage data available"
  fi
else
  echo "   Coverage file not found"
fi
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# à¹€à¸Šà¹‡à¸„ Exit Code
if [ $SONAR_EXIT_CODE -ne 0 ]; then
  echo ""
  echo "âŒ SonarQube Quality Gate Failed!"
  echo "ğŸ’¡ Please check:"
  echo "   - Maintainability Rating must be A"
  echo "   - No Security Issues"
  echo "   - No Reliability Issues"
  echo "   - Coverage must meet threshold"
  exit 1
fi

echo ""
echo "âœ… All checks passed (including SonarQube Quality Gate)!"
exit 0