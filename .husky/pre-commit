#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# ---------------------------------------------------------
# 0. à¹€à¸Šà¹‡à¸„ Current Branch (à¹€à¸à¸´à¹ˆà¸¡à¸ªà¹ˆà¸§à¸™à¸™à¸µà¹‰)
# ---------------------------------------------------------
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
echo "ğŸŒ¿ Current Branch: $CURRENT_BRANCH"

# à¸à¸³à¸«à¸™à¸” Branch à¸—à¸µà¹ˆà¸­à¸™à¸¸à¸à¸²à¸•à¹ƒà¸«à¹‰à¸£à¸±à¸™ (Allow List)
case "$CURRENT_BRANCH" in
  main|develop|feature/*|hotfix/*|bugfix/*)
    echo "âœ… Branch '$CURRENT_BRANCH' is allowed. Proceeding with checks..."
    ;;
  *)
    echo "â­ï¸  Branch '$CURRENT_BRANCH' is ignored."
    echo "   Skipping format, analyze, tests, and SonarQube."
    exit 0
    ;;
esac

echo "ğŸ¶ Husky: Manual checking on STAGED files..."

# 1. à¸«à¸²à¹„à¸Ÿà¸¥à¹Œ .dart à¸—à¸µà¹ˆà¸–à¸¹à¸ Staged (à¹€à¸‰à¸à¸²à¸°à¸—à¸µà¹ˆ Add à¸¡à¸²)
staged_dart_files=$(git diff --cached --name-only --diff-filter=ACMR | grep ".dart$" || true)

# 2. à¹€à¸Šà¹‡à¸„à¸§à¹ˆà¸²à¸¡à¸µà¹„à¸Ÿà¸¥à¹Œ Dart à¹„à¸«à¸¡?
if [ -z "$staged_dart_files" ]; then
  echo "âœ¨ No Dart files changed. Skipping format and analyze."
  echo "   But will still run tests and SonarQube..."
  skip_dart_checks=true
else
  skip_dart_checks=false
  echo "ğŸ“ Checking these files:"
  echo "$staged_dart_files"
fi

# ---------------------------------------------------------
# 3. à¸£à¸±à¸™ Dart Format (à¹€à¸‰à¸à¸²à¸°à¹„à¸Ÿà¸¥à¹Œà¸—à¸µà¹ˆà¹€à¸¥à¸·à¸­à¸)
# ---------------------------------------------------------
if [ "$skip_dart_checks" = false ]; then
  echo ""
  echo "âœ¨ Running Dart Format..."
  dart format $staged_dart_files
fi

# ---------------------------------------------------------
# 4. à¸£à¸±à¸™ Flutter Analyze (à¹€à¸‰à¸à¸²à¸°à¹„à¸Ÿà¸¥à¹Œà¸—à¸µà¹ˆà¹€à¸¥à¸·à¸­à¸)
# ---------------------------------------------------------
echo ""
echo "ğŸ” Running Flutter Analyze..."
# echo "â­ï¸  Skipping Flutter Analyze (testing SonarQube)" # (à¸šà¸£à¸£à¸—à¸±à¸”à¸™à¸µà¹‰ Comment à¹„à¸§à¹‰à¸•à¸²à¸¡à¹€à¸”à¸´à¸¡à¸‚à¸­à¸‡à¸„à¸¸à¸“)

# ---------------------------------------------------------
# 5. à¸£à¸±à¸™ Tests à¸à¸£à¹‰à¸­à¸¡ Generate Coverage
# ---------------------------------------------------------
echo ""
echo "ğŸ§ª Running Flutter Tests with Coverage..."
flutter test --coverage

if [ $? -ne 0 ]; then
  echo ""
  echo "âŒ Tests Failed! Please fix test errors."
  exit 1
fi

echo "âœ… Tests passed! Coverage generated at coverage/lcov.info"

# ---------------------------------------------------------
# 6. à¸£à¸±à¸™ SonarQube Analysis à¹à¸¥à¸°à¹€à¸Šà¹‡à¸„ Quality Gate
# ---------------------------------------------------------
echo ""
echo "ğŸ” Running SonarQube Analysis..."

# à¹€à¸£à¸µà¸¢à¸à¹ƒà¸Šà¹‰ script sonar_gate.sh
# ğŸ’¡ à¸œà¸¡à¸ªà¹ˆà¸‡à¸Šà¸·à¹ˆà¸­ Branch à¹„à¸›à¹ƒà¸«à¹‰à¸”à¹‰à¸§à¸¢ à¹€à¸œà¸·à¹ˆà¸­à¹ƒà¸™ script à¸™à¸±à¹‰à¸™à¸•à¹‰à¸­à¸‡à¹ƒà¸Šà¹‰ (à¹€à¸Šà¹ˆà¸™ -Dsonar.branch.name=$CURRENT_BRANCH)
bash scripts/sonar_gate.sh "$CURRENT_BRANCH"

# à¹€à¸à¹‡à¸š exit code
SONAR_EXIT_CODE=$?

# à¹à¸ªà¸”à¸‡ Coverage Report
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ“Š Coverage Summary:"
if [ -f "coverage/lcov.info" ]; then
  # à¸„à¸³à¸™à¸§à¸“à¸šà¸£à¸£à¸—à¸±à¸”à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”
  total_lines=$(grep -c "^DA:" coverage/lcov.info || echo "0")
  # âš ï¸ à¹€à¸à¸´à¹ˆà¸¡à¸šà¸£à¸£à¸—à¸±à¸”à¸™à¸µà¹‰: à¸„à¸³à¸™à¸§à¸“à¸šà¸£à¸£à¸—à¸±à¸”à¸—à¸µà¹ˆà¸–à¸¹à¸ test (Covered lines) à¹„à¸¡à¹ˆà¸‡à¸±à¹‰à¸™ script à¹€à¸”à¸´à¸¡à¸ˆà¸° error
  covered_lines=$(grep -c "^DA:.*,[1-9]" coverage/lcov.info || echo "0")
  
  if [ "$total_lines" -gt 0 ]; then
    coverage=$(awk "BEGIN {printf \"%.1f\", ($covered_lines/$total_lines)*100}")
    echo "   Coverage: ${coverage}%"
    echo "   Lines: ${covered_lines}/${total_lines}"
  else
    echo "   No coverage data available"
  fi
else
  echo "   Coverage file not found"
fi
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# à¹€à¸Šà¹‡à¸„ Exit Code
if [ $SONAR_EXIT_CODE -ne 0 ]; then
  echo ""
  echo "âŒ SonarQube Quality Gate Failed!"
  echo "ğŸ’¡ Please check SonarQube Dashboard."
  exit 1
fi

echo ""
echo "âœ… All checks passed (including SonarQube Quality Gate)!"
exit 0