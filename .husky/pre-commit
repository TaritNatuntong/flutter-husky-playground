# #!/bin/sh
# # ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡∏ô‡∏ï‡πå Husky (‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏ö)
# . "$(dirname "$0")/_/husky.sh"

# # 1. ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏ß‡∏¢‡πÜ ‡∏ß‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß
# echo "------------------------------------------------"
# echo "üê∂ Husky is watching you..."
# echo "------------------------------------------------"

# # 2. ‡∏à‡∏±‡∏î‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö‡πÇ‡∏Ñ‡πâ‡∏î (Format) ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
# echo "‚ú® Running Dart Format..."
# dart format .

# # 3. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Syntax (Analyze) - ‡∏ñ‡πâ‡∏≤‡∏û‡∏±‡∏á ‡πÉ‡∏´‡πâ‡∏´‡∏¢‡∏∏‡∏î Commit
# echo "üîç Running Flutter Analyze..."
# flutter analyze
# if [ $? -ne 0 ]; then
#   echo "‚ùå Error: Code analysis failed! Please fix issues."
#   exit 1
# fi

# # 4. (‡∏ó‡∏≤‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å) ‡∏£‡∏±‡∏ô Unit Test - ‡∏ñ‡πâ‡∏≤‡∏£‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô ‡πÉ‡∏´‡πâ‡∏´‡∏¢‡∏∏‡∏î Commit
# # echo "üß™ Running Tests..."
# # flutter test
# # if [ $? -ne 0 ]; then
# #   echo "‚ùå Error: Tests failed!"
# #   exit 1
# # fi

# echo "‚úÖ All checks passed! Committing now..."
# echo "------------------------------------------------"

#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

echo "üê∂ Husky: Manual checking on STAGED files..."

# 1. ‡∏´‡∏≤‡πÑ‡∏ü‡∏•‡πå .dart ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å Staged (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà Add ‡∏°‡∏≤)
# - diff --cached --name-only : ‡∏î‡∏π‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô staging area
# - diff --diff-filter=ACMR : ‡πÄ‡∏≠‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà Add, Copy, Modify, Rename (‡πÑ‡∏°‡πà‡πÄ‡∏≠‡∏≤ Deleted)
# - grep .dart$ : ‡πÄ‡∏≠‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÑ‡∏ü‡∏•‡πå‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢ .dart
staged_dart_files=$(git diff --cached --name-only --diff-filter=ACMR | grep ".dart$")

# 2. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå Dart ‡πÑ‡∏´‡∏°? (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡πá‡∏Ç‡πâ‡∏≤‡∏°‡∏Å‡∏≤‡∏£ format/analyze)
if [ -z "$staged_dart_files" ]; then
  echo "‚ú® No Dart files changed. Skipping format and analyze."
  echo "   But will still run tests and SonarQube..."
  
  # ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ‡∏£‡∏±‡∏ô tests ‡πÅ‡∏•‡∏∞ SonarQube
  skip_dart_checks=true
else
  skip_dart_checks=false
  # ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏ä‡πá‡∏Ñ
  echo "üìù Checking these files:"
  echo "$staged_dart_files"
fi

# ---------------------------------------------------------
# 3. ‡∏£‡∏±‡∏ô Dart Format (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)
# ---------------------------------------------------------
if [ "$skip_dart_checks" = false ]; then
  echo ""
  echo "‚ú® Running Dart Format..."
  dart format $staged_dart_files
fi

# ---------------------------------------------------------
# 4. ‡∏£‡∏±‡∏ô Flutter Analyze (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)
# ---------------------------------------------------------
echo ""
echo "üîç Running Flutter Analyze..."
echo "‚è≠Ô∏è  Skipping Flutter Analyze (testing SonarQube)"

# ---------------------------------------------------------
# 5. ‡∏£‡∏±‡∏ô Tests ‡∏û‡∏£‡πâ‡∏≠‡∏° Generate Coverage
# ---------------------------------------------------------
echo ""
echo "üß™ Running Flutter Tests with Coverage..."
flutter test --coverage

if [ $? -ne 0 ]; then
  echo ""
  echo "‚ùå Tests Failed! Please fix test errors."
  exit 1
fi

echo "‚úÖ Tests passed! Coverage generated at coverage/lcov.info"

# ---------------------------------------------------------
# 6. ‡∏£‡∏±‡∏ô SonarQube Analysis ‡πÅ‡∏•‡∏∞‡πÄ‡∏ä‡πá‡∏Ñ Quality Gate
# ---------------------------------------------------------
echo ""
echo "üîç Running SonarQube Analysis..."

# ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ script ‡∏ó‡∏µ‡πà‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß
bash scripts/sonar_gate.sh

# ‡πÄ‡∏ä‡πá‡∏Ñ Exit Code
if [ $? -ne 0 ]; then
  echo ""
  echo "‚ùå SonarQube Quality Gate Failed!"
  echo "üí° Please check:"
  echo "   - Maintainability Rating must be A"
  echo "   - No Security Issues"
  echo "   - No Reliability Issues"
  echo "   - Coverage must meet threshold"
  exit 1
fi

echo ""
echo "‚úÖ All checks passed (including SonarQube Quality Gate)!"
exit 0